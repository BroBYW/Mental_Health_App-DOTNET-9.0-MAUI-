<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:PROJECT.Converters"
             xmlns:vm="clr-namespace:PROJECT.ViewModels"
             xmlns:models="clr-namespace:PROJECT.Models"
             xmlns:pages="clr-namespace:PROJECT.Pages"
             x:Class="PROJECT.Pages.JournalPage"
             x:DataType="vm:JournalViewModel"
             Title="Journal">
    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:MoodToEmojiConverter x:Key="MoodToEmojiConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto" Padding="24" RowSpacing="18">

        <VerticalStackLayout Grid.Row="0" Spacing="18">
            <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                <Image Grid.Column="0" Source="logo.png" WidthRequest="36" HeightRequest="36"/>
                <Button Grid.Column="2" Text="Log Out" BackgroundColor="{StaticResource Primary}" Padding="14,8" Command="{Binding LogoutCommand}" />
            </Grid>

            <Label Text="My Journal" FontSize="36" FontAttributes="Bold" TextColor="{StaticResource MidnightBlue}" />
            <Label Text="Entries" FontSize="24" TextColor="{StaticResource MidnightBlue}" />

            <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                <Button Text="Date ⇅" Command="{Binding SortDateCommand}" Padding="12,0" HeightRequest="40" FontSize="12" />
                <Button Text="Mood ⇅" Command="{Binding SortMoodCommand}" Padding="12,0" HeightRequest="40" FontSize="12" />
                <Label Text="Year:" VerticalOptions="Center" TextColor="{StaticResource MidnightBlue}" FontAttributes="Bold" Margin="5,0,0,0"/>
                <Border StrokeShape="RoundRectangle 8" StrokeThickness="1" Stroke="{StaticResource Primary}" Padding="0" VerticalOptions="Center">
                    <Picker ItemsSource="{Binding Years}" SelectedItem="{Binding SelectedYear}" TextColor="{StaticResource Primary}" Title="Year" WidthRequest="90" HeightRequest="40" HorizontalTextAlignment="Center" FontSize="14" />
                </Border>
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <CollectionView Grid.Row="1" ItemsSource="{Binding Entries}" Margin="0,8,0,0">
            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
                    <Label Text="No entries yet." TextColor="Gray" HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:JournalEntry">
                    <SwipeView>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete" 
               BackgroundColor="{StaticResource MoodAwful}" 
               IconImageSource="icon_history.svg" 
               Command="{Binding DeleteCommand}"
               CommandParameter="{Binding .}" />
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Border BackgroundColor="{StaticResource Primary}" StrokeShape="RoundRectangle 24" StrokeThickness="0" Padding="16" Margin="0,8,0,8">
                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="2,2" Radius="5" Opacity="0.2"/>
                            </Border.Shadow>
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                <Label Grid.Row="0" Grid.Column="0" Text="{Binding Mood, Converter={StaticResource MoodToEmojiConverter}}" FontSize="24"/>
                                <Label Grid.Row="0" Grid.Column="1" Text="{Binding Date, StringFormat='{}{0:MMM dd yyyy}'}" FontAttributes="Bold" TextColor="White" VerticalOptions="Center" Margin="10,0,0,0"/>

                                <Label Grid.Row="0" Grid.Column="2" Text="Swipe ⬅" FontSize="10" TextColor="{StaticResource Secondary}" VerticalOptions="Center" />

                                <Label Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Text="{Binding Summary}" TextColor="{StaticResource Secondary}" LineBreakMode="TailTruncation" MaxLines="3" Margin="10,5,0,0"/>
                                <Image Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Source="{Binding ImagePath}" Aspect="AspectFill" HeightRequest="200" HorizontalOptions="Fill" Margin="0,12,0,0">
                                    <Image.Clip>
                                        <RoundRectangleGeometry CornerRadius="12" Rect="0,0,300,200" />
                                    </Image.Clip>
                                    <Image.Triggers>
                                        <DataTrigger TargetType="Image" Binding="{Binding ImagePath}" Value="{x:Null}">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Image" Binding="{Binding ImagePath}" Value="">
                                            <Setter Property="IsVisible" Value="False" />
                                        </DataTrigger>
                                    </Image.Triggers>
                                </Image>
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Button Grid.Row="2" Text="New Entry" Command="{Binding NewEntryCommand}" FontAttributes="Bold" Margin="0,10,0,0" />

    </Grid>
</ContentPage>