<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PROJECT.ViewModels"
             xmlns:models="clr-namespace:PROJECT.Models"  
             x:Class="PROJECT.Pages.ChatPage"
             x:DataType="vm:ChatViewModel"
             Title="AI Chat">

    <Grid RowDefinitions="*, Auto" Padding="12" RowSpacing="10">

        <CollectionView Grid.Row="0" 
                        ItemsSource="{Binding Messages}" 
                        ItemsUpdatingScrollMode="KeepLastItemInView">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <VerticalStackLayout Padding="0,4">
                        <Border StrokeShape="RoundRectangle 16"
                                StrokeThickness="0"
                                Padding="14,10"
                                MaximumWidthRequest="260">
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsUser}" Value="True">
                                    <Setter Property="HorizontalOptions" Value="End" />
                                    <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                                </DataTrigger>
                                <DataTrigger TargetType="Border" Binding="{Binding IsUser}" Value="False">
                                    <Setter Property="HorizontalOptions" Value="Start" />
                                    <Setter Property="BackgroundColor" Value="{StaticResource Gray200}" />
                                </DataTrigger>
                            </Border.Triggers>

                            <Label Text="{Binding Text}" FontSize="15">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsUser}" Value="True">
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsUser}" Value="False">
                                        <Setter Property="TextColor" Value="Black" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Border>
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Label Grid.Row="0" Text="Thinking..." FontSize="12" TextColor="Gray" 
               VerticalOptions="End" Margin="20,0,0,0" IsVisible="{Binding IsTyping}"/>

        <Grid Grid.Row="1" ColumnDefinitions="*, Auto" ColumnSpacing="8">
            <Border StrokeShape="RoundRectangle 20" Stroke="{StaticResource Primary}" StrokeThickness="1" Padding="10,0">
                <Entry Text="{Binding UserInput}" Placeholder="Type something..." ReturnCommand="{Binding SendCommand}" />
            </Border>
            <Button Grid.Column="1" Text="Send" Command="{Binding SendCommand}" HeightRequest="45" WidthRequest="70" Padding="0"/>
        </Grid>
    </Grid>
</ContentPage>